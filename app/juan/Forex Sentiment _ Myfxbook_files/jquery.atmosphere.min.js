/**
 * Copyright 2012 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/*
 * IE streaming/XDR supports is copied/highly inspired by http://code.google.com/p/jquery-stream/
 *
 * Copyright 2011, Donghwan Kim
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * LocalStorage supports is copied/highly inspired by https://github.com/flowersinthesand/jquery-socket
 * Copyright 2011, Donghwan Kim
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 * */
/**
 * Official documentation of this library: https://github.com/Atmosphere/atmosphere/wiki/jQuery.atmosphere.js-API
 */
jQuery.atmosphere=function(){jQuery(window).bind("beforeunload",function(){jQuery.atmosphere.unsubscribe()});var e=function(e){for(var t,n=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,r={};t=n.exec(e);)r[t[1]]=t[2];return r};return{version:"1.0",requests:[],callbacks:[],connected:!1,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e){},onLocalMessage:function(e){},AtmosphereRequest:function(t){var n,r={timeout:3e5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:60,reconnect:!0,maxStreamingLength:1e7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",pingTimeout:35,lastPingTime:0,connectTimeout:-1,reconnectInterval:0,dropAtmosphereHeaders:!1,uuid:0,shared:!1,readResponsesHeaders:!0,onError:function(e){},onClose:function(e){},onOpen:function(e){},onMessage:function(e){},onReconnect:function(e,t){},onMessagePublished:function(e){},onTransportFailure:function(e,t){},onLocalMessage:function(e){}},o={status:200,responseBody:"",partialMessage:"",junkFull:!1,expectedBodySize:-1,headers:[],state:"messageReceived",transport:"polling",error:null,request:null,id:0},s=null,a=null,i=null,u=null,c=null,l=!0,p=0,d=!1,g=null,m=null,f=jQuery.now();function h(){B(),l=!0,d=!1,p=0,s=null,a=null,i=null,u=null}function y(e){h(),r=jQuery.extend(r,e)}function b(){if(r.shared&&!jQuery.browser.opera){if(null!=(m=function(e){var n,o,s="atmosphere-"+e.url,a={storage:function(){if(jQuery.atmosphere.supportStorage()){var t=window.localStorage,n=function(e){return jQuery.parseJSON(t.getItem(s+"-"+e))},r=function(e,n){t.setItem(s+"-"+e,jQuery.stringifyJSON(n))};return{init:function(){return r("children",n("children").concat([f])),jQuery(window).on("storage.socket",function(e){(e=e.originalEvent).key===s&&e.newValue&&i(e.newValue)}),n("opened")},signal:function(e,n){t.setItem(s,jQuery.stringifyJSON({target:"p",type:e,data:n}))},close:function(){var t,o=n("children");jQuery(window).off("storage.socket"),o&&(t=jQuery.inArray(e.id,o))>-1&&(o.splice(t,1),r("children",o))}}}},windowref:function(){var e=window.open("",s.replace(/\W/g,""));if(e&&!e.closed&&e.callbacks)return{init:function(){return e.callbacks.push(i),e.children.push(t.id),e.opened},signal:function(t,n){!e.closed&&e.fire&&e.fire(jQuery.stringifyJSON({target:"p",type:t,data:n}))},close:function(){function n(e,t){var n=jQuery.inArray(t,e);n>-1&&e.splice(n,1)}o||(n(e.callbacks,i),n(e.children,t.id))}}}};function i(t){var n=jQuery.parseJSON(t),s=n.data;if("c"===n.target)switch(n.type){case"open":v("opening","local",r);break;case"close":o=!0,"aborted"===s.reason?H():(E("","closed",200,r.transport),s.heir===f?H():setTimeout(function(){H()},100));break;case"message":E(s,"messageReceived",200,e.transport);break;case"localMessage":A(s)}}if(!new RegExp("(?:^|; )("+encodeURIComponent(s)+")=([^;]*)").test(document.cookie))return;if(!(n=a.storage()||a.windowref()))return;return{open:function(){var t;return(t=n.init())&&setTimeout(function(){v("opening","local",e)},50),t},send:function(e){n.signal("send",e)},localSend:function(e){n.signal("localSend",jQuery.stringifyJSON({id:f,event:e}))},close:function(){d||(n.signal("close"),n.close())}}}(r))&&("debug"==r.logLevel&&jQuery.atmosphere.debug("Storage service available. All communication will be local"),m.open(r)))return;"debug"==r.logLevel&&jQuery.atmosphere.debug("No Storage service available."),m=null}"websocket"!=r.transport&&"sse"!=r.transport?(v("opening",r.transport,r),T()):"websocket"==r.transport?null!=r.webSocketImpl||window.WebSocket||window.MozWebSocket?function e(t){o.transport="websocket";var n=(r.url,a=S(r),decodeURI(jQuery('<a href="'+a+'"/>')[0].href.replace(/^http/,"ws")));var a;var i=!1;"debug"==r.logLevel&&(jQuery.atmosphere.debug("Invoking executeWebSocket"),jQuery.atmosphere.debug("Using URL: "+n));t&&v("re-opening","websocket",r);if(!r.reconnect)return void(null!=s&&s.close());s=function(e){return null!=r.webSocketImpl?r.webSocketImpl:window.WebSocket?new WebSocket(e):new MozWebSocket(e)}(n);r.connectTimeout>0&&(r.id=setTimeout(function(){if(!t){s.onclose({code:1002,reason:"",wasClean:!1});try{s.close()}catch(e){}}},r.connectTimeout));s.onopen=function(e){"debug"==r.logLevel&&jQuery.atmosphere.debug("Websocket successfully opened"),t?r.onOpen(r):v("opening","websocket",r),t=!0,"POST"==r.method&&(o.state="messageReceived",s.send(r.data))};s.onmessage=function(e){-1!=e.data.indexOf("parent.callback")&&jQuery.atmosphere.log(r.logLevel,["parent.callback no longer supported with 0.8 version and up. Please upgrade"]),o.state="messageReceived",o.status=200;var e=e.data,t=Q(e,r,o);t||(P(),o.responseBody="")};s.onerror=function(e){clearTimeout(r.id)};s.onclose=function(n){if(!i){var s=n.reason;if(""===s)switch(n.code){case 1e3:s="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:s="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:s="The endpoint is terminating the connection due to a protocol error.";break;case 1003:s="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:s="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:s="Unknown: no status code was provided even though one was expected.";break;case 1006:s="Connection was closed abnormally (that is, with no close frame being sent)."}jQuery.atmosphere.warn("Websocket closed, reason: "+s),jQuery.atmosphere.warn("Websocket closed, wasClean: "+n.wasClean),o.state="closed",o.responseBody="",o.status=t?200:501,P(),clearTimeout(r.id),i=!0,d?jQuery.atmosphere.log(r.logLevel,["Websocket closed normally"]):t?r.reconnect&&"websocket"==o.transport&&(r.reconnect&&p++<r.maxRequest?(r.requestCount=p,o.responseBody="",e(!0)):(jQuery.atmosphere.log(r.logLevel,["Websocket reconnect maximum try reached "+r.requestCount]),jQuery.atmosphere.warn("Websocket error, reason: "+n.reason),w())):k("Websocket failed. Downgrading to Comet and resending")}}}(!1):k("Websocket is not supported, using request.fallbackTransport ("+r.fallbackTransport+")"):"sse"==r.transport&&(window.EventSource?function e(t){o.transport="sse";var n=(r.url,S(r));"debug"==r.logLevel&&(jQuery.atmosphere.debug("Invoking executeSSE"),jQuery.atmosphere.debug("Using URL: "+n));t&&v("re-opening","sse",r);if(!r.reconnect)return void(null!=a&&a.close());a=new EventSource(n,{withCredentials:r.withCredentials});r.connectTimeout>0&&(r.id=setTimeout(function(){t||a.close()},r.connectTimeout));a.onopen=function(e){"debug"==r.logLevel&&jQuery.atmosphere.debug("SSE successfully opened"),t||v("opening","sse",r),t=!0,"POST"==r.method&&(o.state="messageReceived",a.send(r.data))};a.onmessage=function(e){if(e.origin=="http://"+window.location.host){o.state="messageReceived",o.status=200;var e=e.data,t=Q(e,r,o);0==jQuery.trim(e).length&&(t=!0),t||(P(),o.responseBody="")}else jQuery.atmosphere.log(r.logLevel,["Origin was not http://"+window.location.host])};a.onerror=function(n){clearTimeout(r.id),o.state="closed",o.responseBody="",o.status=t?200:501,P(),d?jQuery.atmosphere.log(r.logLevel,["SSE closed normally"]):t?r.reconnect&&"sse"==o.transport&&(p++<r.maxRequest?(r.requestCount=p,o.responseBody="",e(!0)):(a.close(),jQuery.atmosphere.log(r.logLevel,["SSE reconnect maximum try reached "+r.requestCount]),w())):k("SSE failed. Downgrading to fallback transport and resending")}}(!1):k("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+r.fallbackTransport+")"))}function v(e,t,s){r.shared&&"local"!=t&&!jQuery.browser.opera&&function(){var e,t="atmosphere-"+r.url,o=function(){if(jQuery.atmosphere.supportStorage()){var e=window.localStorage;return{init:function(){jQuery(window).on("storage.socket",function(e){(e=e.originalEvent).key===t&&e.newValue&&a(e.newValue)})},signal:function(n,r){e.setItem(t,jQuery.stringifyJSON({target:"c",type:n,data:r}))},get:function(n){return jQuery.parseJSON(e.getItem(t+"-"+n))},set:function(n,r){e.setItem(t+"-"+n,jQuery.stringifyJSON(r))},close:function(){jQuery(window).off("storage.socket"),e.removeItem(t),e.removeItem(t+"-opened"),e.removeItem(t+"-children")}}}},s=function(){var e=t.replace(/\W/g,""),n=(jQuery('iframe[name="'+e+'"]')[0]||jQuery('<iframe name="'+e+'" />').hide().appendTo("body")[0]).contentWindow;return{init:function(){n.callbacks=[a],n.fire=function(e){var t;for(t=0;t<n.callbacks.length;t++)n.callbacks[t](e)}},signal:function(e,t){!n.closed&&n.fire&&n.fire(jQuery.stringifyJSON({target:"c",type:e,data:t}))},get:function(e){return n.closed?null:n[e]},set:function(e,t){n.closed||(n[e]=t)},close:function(){}}};function a(e){var t=jQuery.parseJSON(e),n=t.data;if("p"===t.target)switch(t.type){case"send":D(n);break;case"localSend":A(n);break;case"close":H()}}g=function(t){e.signal("message",t)},document.cookie=encodeURIComponent(t)+"="+jQuery.now(),(e=o()||s()).init(),"debug"==r.logLevel&&jQuery.atmosphere.debug("Installed StorageService "+e),e.set("children",[]),null==e.get("opened")||e.get("opened")||e.set("opened",!1),n=e}(),null!=n&&n.set("opened",!0),s.close=function(){H(),s.reconnect=!1},o.request=s;var a=o.state;o.state=e,o.status=200;var i=o.transport;o.transport=t,P(),o.state=a,o.transport=i}function j(e){var t=r;null!=e&&void 0!==e&&(t=e);var n=t.url,o=t.data;t.attachHeadersAsQueryString&&(n=S(t),""!=o&&(n+="&X-Atmosphere-Post-Body="+o),o=""),c=jQuery.ajax({url:n,type:t.method,dataType:"jsonp",error:function(e,n,r){e.status<300&&t.requestCount++<t.maxRequest?C(c,t):E(n,"error",e.status,t.transport)},jsonp:"jsonpTransport",success:function(e){if(t.requestCount++<t.maxRequest){t.executeCallbackBeforeReconnect||C(c,t);var n=e.message;if(null!=n&&"string"!=typeof n)try{n=jQuery.stringifyJSON(n)}catch(e){}E(n,"messageReceived",200,t.transport),t.executeCallbackBeforeReconnect&&C(c,t)}else jQuery.atmosphere.log(r.logLevel,["JSONP reconnect maximum try reached "+r.requestCount]),w()},data:t.data,beforeSend:function(e){R(e,t,!1)}})}function w(){o.state="error",o.responseBody="",o.status=500,P()}function Q(e,t,n){if(t.trackMessageLength){var r=[],o=e.indexOf(t.messageDelimiter);if(0==n.partialMessage.length)for(;-1!=o;){var s=e.substring(0,o);r.push(s),o=(e=e.substring(o+t.messageDelimiter.length,e.length)).indexOf(t.messageDelimiter)}for(0!=e.length&&(n.partialMessage+=e),o=n.partialMessage.indexOf(t.messageDelimiter);-1!=o;)s=n.partialMessage.substring(0,o),r.push(s),n.partialMessage=n.partialMessage.substring(o+t.messageDelimiter.length,n.partialMessage.length),o=n.partialMessage.indexOf(t.messageDelimiter);return 0==r.length||(n.responseBody=r.join(t.messageDelimiter),!1)}return n.responseBody=e,!1}function k(e){jQuery.atmosphere.log(r.logLevel,[e]),void 0!==r.onTransportFailure?r.onTransportFailure(e,r):void 0!==jQuery.atmosphere.onTransportFailure&&jQuery.atmosphere.onTransportFailure(e,r),r.transport=r.fallbackTransport,(r.reconnect&&"none"!=r.transport||null==r.transport)&&(r.method=r.fallbackMethod,o.transport=r.fallbackTransport,r.id=setTimeout(function(){b()},r.reconnectInterval))}function S(e){var t=r;null!=e&&void 0!==e&&(t=e);var n=t.url;return t.attachHeadersAsQueryString?-1!=n.indexOf("X-Atmosphere-Framework")?n:(n+=-1!=n.indexOf("?")?"&":"?",n+="X-Atmosphere-tracking-id="+t.uuid,n+="&X-Atmosphere-Framework="+jQuery.atmosphere.version,n+="&X-Atmosphere-Transport="+t.transport,n+="&token="+TOKEN,n+="&lastCalendarEventTime="+lastCalendarEventTime,n+=getAtmosphereParams(),t.trackMessageLength&&(n+="&X-Atmosphere-TrackMessageSize=true"),null!=t.lastTimestamp?n+="&X-Cache-Date="+t.lastTimestamp:n+="&X-Cache-Date=0",""!=t.contentType&&(n+="&Content-Type="+t.contentType),jQuery.each(t.headers,function(r,s){var a=jQuery.isFunction(s)?s.call(this,t,e,o):s;null!=a&&(n+="&"+encodeURIComponent(r)+"="+encodeURIComponent(a))}),n):n}function T(t){var n=r;if(null==t&&void 0===t||(n=t),"jsonp"==n.transport||n.enableXDR&&jQuery.atmosphere.checkCORSSupport())j(n);else if("ajax"!=n.transport)if("streaming"==n.transport&&jQuery.browser.msie&&jQuery.browser.version<10)n.enableXDR&&window.XDomainRequest?O(n):q(n);else if(n.enableXDR&&window.XDomainRequest)O(n);else if(n.reconnect&&n.requestCount++<n.maxRequest){var s=(jQuery.browser.msie&&"undefined"==typeof XMLHttpRequest&&(XMLHttpRequest=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}throw new Error("This browser does not support XMLHttpRequest.")}),new XMLHttpRequest);R(s,n,!0),n.suspend&&(i=s),"polling"!=n.transport&&(o.transport=n.transport);jQuery.browser.msie||(s.onerror=function(){!0;try{o.status=XMLHttpRequest.status}catch(e){o.status=404}o.state="error",C(s,n,!0)}),s.onreadystatechange=function(){if(!d){var t=!1,a=!1;if("streaming"==n.transport)if(jQuery.browser.msie&&4!=s.readyState)s.readyState>=3&&(a=!0);else if(n.readyState>2&&4==s.readyState)return n.readyState=0,n.lastIndex=0,void C(s,n,!0);n.readyState=s.readyState,4==s.readyState?jQuery.browser.msie?a=!0:"streaming"==n.transport?a=!0:"long-polling"==n.transport&&(a=!0,clearTimeout(n.id)):(!jQuery.browser.msie||jQuery.browser.msie&&jQuery.browser.version>=10)&&3==s.readyState&&200==s.status&&"long-polling"!=n.transport?(a=!0,jQuery.atmosphere.connected?jQuery.atmosphere.connected=!0:(jQuery.atmosphere.connected=!0,r.onOpen(o))):clearTimeout(n.id);try{if(n.readResponsesHeaders){var i=s.getResponseHeader("X-Atmosphere-tracking-id");null==i&&null==i||(r.uuid=i.split(" ").pop())}}catch(e){}if(a){var u=s.responseText;try{if(n.readResponsesHeaders){var c=s.getResponseHeader("X-Cache-Date");null==c&&null==c||(r.lastTimestamp=c.split(" ").pop())}}catch(e){}if("streaming"==n.transport){n.lastPingTime=(new Date).getTime();var l=u.substring(n.lastIndex,u.length);if(o.isJunkEnded=!0,o.junkFull||-1!=l.indexOf("\x3c!-- Welcome to the Atmosphere Framework.")&&-1!=l.indexOf("\x3c!-- EOD --\x3e"))o.junkFull=!0;else if(!jQuery.browser.opera)return;if(0==n.lastIndex&&-1!=l.indexOf("\x3c!-- Welcome to the Atmosphere Framework.")&&-1!=l.indexOf("\x3c!-- EOD --\x3e")&&(o.isJunkEnded=!1),o.isJunkEnded){t=Q(u.substring(n.lastIndex,u.length),n,o)}else{var p="\x3c!-- EOD --\x3e".length,g=l.indexOf("\x3c!-- EOD --\x3e")+p;g>p&&g!=l.length?(o.responseBody=l.substring(g),t=Q(o.responseBody,n,o)):t=!0}if(n.lastIndex=u.length,jQuery.browser.opera&&jQuery.atmosphere.iterate(function(){if(s.responseText.length>n.lastIndex){try{o.status=s.status,o.headers=e(s.getAllResponseHeaders()),r.readResponsesHeaders&&r.headers&&jQuery.each(r.headers,function(e){var t=s.getResponseHeader(e);t&&(o.headers[e]=t)})}catch(e){o.status=404}if(o.junkFull)n.lastPingTime=(new Date).getTime(),o.state="messageReceived",o.responseBody=s.responseText.substring(n.lastIndex),n.lastIndex=s.responseText.length,P(),"streaming"==n.transport&&s.responseText.length>n.maxStreamingLength&&(s.abort(),R(s,n,!0));else{var t="\x3c!-- EOD --\x3e".length,a=s.responseText.indexOf("\x3c!-- EOD --\x3e")+t;n.lastIndex=a,o.junkFull=!0}}},0),t)return}else t=Q(u,n,o),n.lastIndex=u.length;try{o.status=s.status,o.headers=e(s.getAllResponseHeaders()),r.readResponsesHeaders&&r.headers&&jQuery.each(r.headers,function(e){var t=s.getResponseHeader(e);t&&(o.headers[e]=t)})}catch(e){o.status=404}n.suspend?o.state=0==o.status?"closed":"messageReceived":o.state="messagePublished",n.executeCallbackBeforeReconnect||C(s,n,!1),-1!=o.responseBody.indexOf("parent.callback")&&jQuery.atmosphere.log(n.logLevel,["parent.callback no longer supported with 0.8 version and up. Please upgrade"]),P(),n.executeCallbackBeforeReconnect&&C(s,n,!1),"streaming"==n.transport&&u.length>n.maxStreamingLength&&(s.abort(),R(s,n,!0))}}},s.send(n.data),n.suspend&&(n.id=setTimeout(function(){l&&(s.abort(),y(n),b())},n.timeout),n.lastPingTime=(new Date).getTime(),n.ping=setTimeout(function(){x(s,n)},1e3*n.pingTimeout)),l=!0}else jQuery.atmosphere.log(n.logLevel,["Max re-connection reached."]),w();else!function(e){var t=r;null!=e&&void 0!==e&&(t=e);var n=t.url,o=t.data;t.attachHeadersAsQueryString&&(n=S(t),""!=o&&(n+="&X-Atmosphere-Post-Body="+o),o=""),c=jQuery.ajax({url:n,type:t.method,error:function(e,n,r){e.status<300&&t.requestCount++<t.maxRequest?C(c,t):E(n,"error",e.status,t.transport)},success:function(e,n,o){t.requestCount++<t.maxRequest?(t.executeCallbackBeforeReconnect||C(c,t),E(e,"messageReceived",200,t.transport),t.executeCallbackBeforeReconnect&&C(c,t)):(jQuery.atmosphere.log(r.logLevel,["AJAX reconnect maximum try reached "+r.requestCount]),w())},data:t.data,beforeSend:function(e){R(e,t,!1)}})}(t)}function x(e,t){var n=((new Date).getTime()-t.lastPingTime)/1e3;(jQuery.atmosphere.connected||!jQuery.atmosphere.connected&&jQuery.browser.msie)&&n>t.pingTimeout&&(null!=e?(e.abort(),y(t),b()):(!function(e){null!=u&&(u.close(),u=null);jQuery.atmosphere.connected=!1}(),q(t))),clearTimeout(t.ping),t.ping=setTimeout(function(){x(e,t)},1e3*t.pingTimeout)}function R(e,t,n){var s=S(t);s=jQuery.atmosphere.prepareURL(s),n&&(e.open(t.method,s,!0),t.connectTimeout>-1&&(t.id=setTimeout(function(){0==t.requestCount&&(e.abort(),E("Connect timeout","closed",200,t.transport))},t.connectTimeout))),r.withCredentials&&"withCredentials"in e&&(e.withCredentials=!0),r.dropAtmosphereHeaders||(e.setRequestHeader("X-Atmosphere-Framework",jQuery.atmosphere.version),e.setRequestHeader("X-Atmosphere-Transport",t.transport),null!=t.lastTimestamp?e.setRequestHeader("X-Cache-Date",t.lastTimestamp):e.setRequestHeader("X-Cache-Date",0),t.trackMessageLength&&e.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),""!=t.contentType&&e.setRequestHeader("Content-Type",t.contentType),e.setRequestHeader("X-Atmosphere-tracking-id",t.uuid)),jQuery.each(t.headers,function(r,s){var a=jQuery.isFunction(s)?s.call(this,e,t,n,o):s;null!=a&&e.setRequestHeader(r,a)})}function C(e,t,n){(n||t.suspend&&200==e.status&&"streaming"!=t.transport&&l)&&t.reconnect&&(jQuery.atmosphere.connected=!1,o.junkFull=!1,v("re-opening",t.transport,t),clearTimeout(t.id),t.id=setTimeout(function(){jQuery.atmosphere.connected||T()},t.reconnectInterval))}function O(e){(u=function(e){var t=r;null!=e&&void 0!==e&&(t=e);var n=t.transport,o=0,s=function(e){var t=e.responseText,r=!1;if(-1!=t.indexOf("\x3c!-- Welcome to the Atmosphere Framework.")&&(r=!0),r){var s="\x3c!-- EOD --\x3e".length,a=t.indexOf("\x3c!-- EOD --\x3e");-1!==a&&(t=t.substring(a+s+o),o+=t.length)}E(t,"messageReceived",200,n)},a=new window.XDomainRequest,i=t.rewriteURL||function(e){var t=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(t&&t[1]){case"JSESSIONID":return e.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+t[2]+"$1");case"PHPSESSID":return e.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+t[2]+"&").replace(/&$/,"")}return e};return a.onprogress=function(){s(a)},a.onerror=function(){"polling"!=t.transport&&E(a.responseText,"error",500,n)},a.onload=function(){""!=a.responseText&&s(a),"long-polling"==t.transport&&T()},{open:function(){"POST"==t.method&&(t.attachHeadersAsQueryString=!0);var e=S(t);"POST"==t.method&&(e+="&X-Atmosphere-Post-Body="+t.data),a.open(t.method,i(e)),a.send(),t.connectTimeout>-1&&(t.id=setTimeout(function(){0==t.requestCount&&(a.abort(),E("Connect timeout","closed",200,t.transport))},t.connectTimeout))},close:function(){a.abort(),E(a.responseText,"closed",200,n)}}}(e)).open()}function q(e){(u=function(e){var t,n=r;null!=e&&void 0!==e&&(n=e);var s=new window.ActiveXObject("htmlfile");s.open(),s.close();var a=n.url;"polling"!=n.transport&&(o.transport=n.transport);return{open:function(){var e=s.createElement("iframe");a=S(n),""!=n.data&&(a+="&X-Atmosphere-Post-Body="+n.data),a=jQuery.atmosphere.prepareURL(a),e.src=a,s.body.appendChild(e),n.lastPingTime=(new Date).getTime(),null==n.ping&&(n.ping=setTimeout(function(){x(null,n)},1e3*n.pingTimeout));var r=e.contentDocument||e.contentWindow.document;t=jQuery.atmosphere.iterate(function(){try{if(!r.firstChild)return;if("complete"===r.readyState)try{jQuery.noop(r.fileSize)}catch(e){return E("Connection Failure","error",500,n.transport),!1}var e=r.body?r.body.lastChild:r,s=function(){jQuery.atmosphere.connected=!0;var t=e.cloneNode(!0);t.appendChild(r.createTextNode("."));var n=t.innerText,o=!0;if(-1==n.indexOf("\x3c!-- Welcome to the Atmosphere Framework.")&&(o=!1),o){var s="\x3c!-- EOD --\x3e".length,a=n.indexOf("\x3c!-- EOD --\x3e")+s;n=n.substring(a)}return n.substring(0,n.length-1)};if(!jQuery.nodeName(e,"pre")){var a=r.head||r.getElementsByTagName("head")[0]||r.documentElement||r,i=r.createElement("script");i.text="document.write('<plaintext>')",a.insertBefore(i,a.firstChild),a.removeChild(i),e=r.body.lastChild}return E(s(),"opening",200,n.transport),t=jQuery.atmosphere.iterate(function(){var t=s();if(t.length>n.lastIndex&&(o.status=200,E(t,"messageReceived",200,n.transport),e.innerText="",n.lastIndex=0),"complete"===r.readyState)return E("","re-opening",200,n.transport),q(n),!1},null),!1}catch(e){jQuery.atmosphere.error(e)}})},close:function(){t&&t(),s.execCommand("Stop"),E("","closed",200,n.transport)}}}(e)).open()}function D(e){null!=m?function(e){m.send(e)}(e):null!=i||null!=a?L(e):null!=u?function(e){if(r.enableXDR&&jQuery.atmosphere.checkCORSSupport()){var t=I(e);t.reconnect=!1,j(t)}else L(e)}(e):null!=c?function(e){L(e)}(e):null!=s&&function(e){var t,n=M(e);try{t=null!=r.webSocketUrl?r.webSocketPathDelimiter+r.webSocketUrl+r.webSocketPathDelimiter+n:n,s.send(t)}catch(n){s.onclose=function(e){},s.close(),k("Websocket failed. Downgrading to Comet and resending "+t),L(e)}}(e)}function L(e){T(I(e))}function M(e){var t=e;return"object"==typeof t&&(t=e.data),t}function I(e){var t=M(e),n={connected:!1,timeout:6e4,method:"POST",url:r.url,contentType:r.contentType,headers:{},reconnect:!0,callback:null,data:t,suspend:!1,maxRequest:60,logLevel:"info",requestCount:0,transport:"polling",attachHeadersAsQueryString:!0,enableXDR:r.enableXDR,uuid:r.uuid};return"object"==typeof e&&(n=jQuery.extend(n,e)),n}function A(e){var t=jQuery.parseJSON(e);t.id!=f&&(void 0!==r.onLocalMessage?r.onLocalMessage(t.event):void 0!==jQuery.atmosphere.onLocalMessage&&jQuery.atmosphere.onLocalMessage(t.event))}function E(e,t,n,s){"messageReceived"==t&&(r.lastPingTime=(new Date).getTime(),Q(e,r,o))||(o.transport=s,o.status=n,-1==o.expectedBodySize&&(o.responseBody=e),o.state=t,P())}function X(e,t){switch(e.state){case"messageReceived":void 0!==t.onMessage&&t.onMessage(e);break;case"error":void 0!==t.onError&&t.onError(e);break;case"opening":void 0!==t.onOpen&&t.onOpen(e);break;case"messagePublished":void 0!==t.onMessagePublished&&t.onMessagePublished(e);break;case"re-opening":void 0!==t.onReconnect&&t.onReconnect(r,e);break;case"unsubscribe":case"closed":void 0!==t.onClose&&t.onClose(e)}}function P(){var e=function(e,t){t(o)};null==m&&null!=g&&g(o.responseBody);for(var t,n="string"==typeof o.responseBody?o.responseBody.split(r.messageDelimiter):new Array(o.responseBody),s=0;s<n.length;s++)if(!(n.length>1&&0==n[s].length)){if(o.responseBody=jQuery.trim(n[s]),0==o.responseBody.length&&"streaming"==o.transport&&"messageReceived"==o.state)if(navigator.userAgent.toLowerCase().indexOf("android")>-1)continue;if(X(t=o,r),X(t,jQuery.atmosphere),jQuery.atmosphere.callbacks.length>0){"debug"==r.logLevel&&jQuery.atmosphere.debug("Invoking "+jQuery.atmosphere.callbacks.length+" global callbacks: "+o.state);try{jQuery.each(jQuery.atmosphere.callbacks,e)}catch(e){jQuery.atmosphere.log(r.logLevel,["Callback exception"+e])}}if("function"==typeof r.callback){"debug"==r.logLevel&&jQuery.atmosphere.debug("Invoking request callbacks");try{r.callback(o)}catch(e){jQuery.atmosphere.log(r.logLevel,["Callback exception"+e])}}}}function H(){r.reconnect=!1,o.request=r,l=!1,d=!0,o.state="unsubscribe",o.responseBody="",o.status=408,P(),B(),null==m&&null!=g&&(n.signal("close",{reason:"",heir:d?n.get("children")[0]:f}),document.cookie=encodeURIComponent("atmosphere-"+r.url)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"),null!=n&&n.close(),null!=m&&m.close()}function B(){null!=u&&(u.close(),u=null),null!=c&&(c.abort(),c=null),null!=i&&(i.abort(),i=null),null!=s&&(s.close(),s=null),null!=a&&(a.close(),a=null)}y(t),this.subscribe=function(e){y(e),b()},this.execute=function(){b()},this.invokeCallback=function(){P()},this.close=function(){H()},this.getUrl=function(){return r.url},this.push=function(e){D(e)},this.pushLocal=function(e){!function(e){try{m?m.localSend(e):n.signal("localMessage",jQuery.stringifyJSON({id:f,event:e}))}catch(e){jQuery.atmosphere.error(e)}}(e)},this.response=o},subscribe:function(e,t,n){jQuery.atmosphere.unsubscribe(),"function"==typeof t&&jQuery.atmosphere.addCallback(t),"string"!=typeof e?n=e:n.url=e;var r=new jQuery.atmosphere.AtmosphereRequest(n);return r.execute(),jQuery.atmosphere.requests[jQuery.atmosphere.requests.length]=r,r},addCallback:function(e){-1==jQuery.inArray(e,jQuery.atmosphere.callbacks)&&jQuery.atmosphere.callbacks.push(e)},removeCallback:function(e){var t=jQuery.inArray(e,jQuery.atmosphere.callbacks);-1!=t&&jQuery.atmosphere.callbacks.splice(t,1)},unsubscribe:function(){if(jQuery.atmosphere.requests.length>0)for(var e=0;e<jQuery.atmosphere.requests.length;e++)jQuery.atmosphere.requests[e].close(),clearTimeout(jQuery.atmosphere.requests[e].id),clearTimeout(jQuery.atmosphere.requests[e].response.request.ping);jQuery.atmosphere.requests=[],jQuery.atmosphere.callbacks=[]},unsubscribeUrl:function(e){var t=-1;if(jQuery.atmosphere.requests.length>0)for(var n=0;n<jQuery.atmosphere.requests.length;n++){var r=jQuery.atmosphere.requests[n];if(r.getUrl()==e){r.close(),clearTimeout(r.id),t=n;break}}t>=0&&jQuery.atmosphere.requests.splice(t,1)},publish:function(e){"function"==typeof e.callback&&jQuery.atmosphere.addCallback(callback),e.transport="polling";var t=new jQuery.atmosphere.AtmosphereRequest(e);return jQuery.atmosphere.requests[jQuery.atmosphere.requests.length]=t,t},checkCORSSupport:function(){return!(!jQuery.browser.msie||window.XDomainRequest)||(!!jQuery.browser.opera||!!(navigator.userAgent.toLowerCase().indexOf("android")>-1))},S4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid:function(){return jQuery.atmosphere.S4()+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+"-"+jQuery.atmosphere.S4()+jQuery.atmosphere.S4()+jQuery.atmosphere.S4()},prepareURL:function(e){var t=jQuery.now(),n=e.replace(/([?&])_=[^&]*/,"$1_="+t);return n+(n===e?(/\?/.test(e)?"&":"?")+"_="+t:"")},param:function(e){return jQuery.param(e,jQuery.ajaxSettings.traditional)},supportStorage:function(){var e=window.localStorage;if(e)try{return e.setItem("t","t"),e.removeItem("t"),!!window.StorageEvent||"[object Storage]"===Object.prototype.toString.call(e)}catch(e){}return!1},iterate:function(e,t){var n;return t=t||0,function r(){n=setTimeout(function(){!1!==e()&&r()},t)}(),function(){clearTimeout(n)}},log:function(e,t){if(window.console){var n=window.console[e];"function"==typeof n&&n.apply(window.console,t)}},warn:function(){jQuery.atmosphere.log("warn",arguments)},info:function(){jQuery.atmosphere.log("info",arguments)},debug:function(){jQuery.atmosphere.log("debug",arguments)},error:function(){jQuery.atmosphere.log("error",arguments)}}}(),function(e){var t=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,n={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function r(e){return'"'+e.replace(t,function(e){var t=n[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"'}function o(e){return e<10?"0"+e:e}e.stringifyJSON=function(e){return window.JSON&&window.JSON.stringify?window.JSON.stringify(e):function e(t,n){var s,a,i,u,c=n[t],l=typeof c;switch(c&&"object"==typeof c&&"function"==typeof c.toJSON&&(l=typeof(c=c.toJSON(t))),l){case"string":return r(c);case"number":return isFinite(c)?String(c):"null";case"boolean":return String(c);case"object":if(!c)return"null";switch(Object.prototype.toString.call(c)){case"[object Date]":return isFinite(c.valueOf())?'"'+c.getUTCFullYear()+"-"+o(c.getUTCMonth()+1)+"-"+o(c.getUTCDate())+"T"+o(c.getUTCHours())+":"+o(c.getUTCMinutes())+":"+o(c.getUTCSeconds())+'Z"':"null";case"[object Array]":for(i=c.length,u=[],s=0;s<i;s++)u.push(e(s,c)||"null");return"["+u.join(",")+"]";default:for(s in u=[],c)Object.prototype.hasOwnProperty.call(c,s)&&(a=e(s,c))&&u.push(r(s)+":"+a);return"{"+u.join(",")+"}"}}}("",{"":e})}}(jQuery);